<%= render 'layouts/topbody' %>
<div class="users wrapper wrapper-content animated fadeInRight">
  <div class="row">
    <div class="col-sm-12">
      <div class="ibox float-e-margins">
        <div class="ibox-title">
          <h5>Keypair</h5>
          <% if (can? :process, RailsLti2Provider::Tool) && (sadmin_signed_in? || current_user.is_superior?) %>
          <%= link_to 'Edit', edit_lti_path(@keypair), id: "keypair_edit", :name => "keypair_edit", :title => 'Edit', class: "btn btn-primary btn-xs pull-right" %>
          <% end %>
        </div>
        <div class="ibox-content">
          <div class="row">
            <% if sadmin_signed_in? || (current_user && current_user.is_superior?) %>
            <div class="form-group">
              <label class="col-sm-2 control-label">Account</label>
              <div class="col-sm-10">
                <p class="form-control-static"><%= @keypair.account.name if @keypair.account%></p>
              </div><br>
            </div>
            <div class="hr-line-dashed"></div>
            <% end %>
            <div class="form-group">
              <label class="col-sm-2 control-label">Key</label>
              <div class="col-sm-10">
                <p class="form-control-static"><%= @keypair.uuid %></p>
              </div><br>
            </div>
            <div class="hr-line-dashed"></div>
            <div class="form-group">
              <label class="col-sm-2 control-label">Secret</label>
              <div class="col-sm-10">
                <p class="form-control-static"><%= @keypair.shared_secret %></p>
              </div><br><br>
            </div>
            <div class="hr-line-dashed"></div>
            <div class="form-group">
              <label class="col-sm-2 control-label">Active Resources</label>
              <div class="col-sm-10 form-control-static">
                <span style="word-wrap: break-word;"><%= @keypair.resource_type %></span>
              </div><br><br>
            </div>
            <% if (current_user && !current_user.is_member?) %>
            <div class="hr-line-dashed"></div>
            <div class="ibox form-group collapsed">
              <label class="col-sm-2 control-label">Tool Statistics
                <a class="collapse-link">
                  <i class="fa fa-chevron-up text-muted"></i>
                </a>
              </label>
              <div class="ibox-content">
                <div class="input-group form-group field col-lg-12">
                  <table class="table">
                    <thead>
                      <tr>
                        <th colspan="3" style="background-color: white;">
                          <div class="btn btn-default btn-sm pull-right" data-toggle="collapse" data-target="#all_tool_stats">View Resource Specific Stats</div>
                          General Tool Stats:
                        </th>
                      </tr>
                       <tr>
                         <th>Users <span class="badge label-default"><%= @keypair.usage['General'] ? "#{@keypair.usage['General']['all_users'].split(',').length}" : "0" %></span></th>
                         <th>Total Usage</th>
                         <th>Linked Resources <span class="badge label-default"><%=
                             (@lti_resource.nil? ? '0' : "#{@lti_resource.map { |r| r.length }.first}") %></span></th>
                      </tr>
                    </thead>
                    <tbody>
                      <% if @keypair.usage['General'] %>
                      <td><div class="pre-scrollable" style="word-wrap: break-word;">
                      <% @keypair.usage['General']['all_users'].split(",").each do |u| %>
                        <%= u %><br>
                      <% end %>
                      </div></td>
                      <td><%= @keypair.usage['General']['uses'] %></td>
                      <% else %>
                      <td>None</td>
                      <td>0</td>
                      <% end %>
                      <td>
                      <% unless @lti_resource.empty? %>
                      <% @lti_resource.each do |resource| %>
                        <% resource.each do |r| %>
                          <%= link_to(r.name, r) %>
                        <% end %>
                      <% end %>
                      <% else %>
                      N/A
                      <% end %>
                      </td>
                    </tbody>
                  </table>
                </div>
                <div class="collapse" id="all_tool_stats">
                  <% @keypair.usage.each do |resource, datum| %>
                    <% if datum['users'] %>
                      <div>
                        <div colspan="5">
                          <div class="btn btn-block btn-sm btn-outline btn-default table-expander" style="text-align: left;" data-toggle="collapse" data-target="#<%= resource %>">
                            <% @resource = datum['resource_type'].capitalize.constantize.find_by(resource_link_id: resource, account_id: @keypair.account_id) %>
                            <b><%= @resource.nil? ? resource : link_to(@resource.name, @resource, style: 'color: inherit;') %></b> Usage Stats
                            <span class="pull-right">Click to expand</span>
                          </div>
                          <div class="collapse" id="<%= resource %>">
                            <table class="table table-striped table-bordered dt-responsive" id="res_usage_<%= resource %>" style="width: 100%;" >
                               <thead>
                               <tr>
                                  <th>First</th>
                                  <th>Last</th>
                                  <th>Email</th>
                                  <th>Usage</th>
                                  <th>Last Use (YYYY/MM/DD)</th>
                               </tr>
                               </thead>
                               <tbody>
                                  <% datum['users'].each do |uid, u_datum| %>
                                    <tr>
                                    <td><%= u_datum['first'] %></td>
                                    <td><%= u_datum['last'] %></td>
                                    <td><%= u_datum['email'] %></td>
                                    <td><%= u_datum['uses'] %></td>
                                    <td><%= u_datum['last_login'] %></td>
                                    </tr>
                                  <% end %>
                               </tbody>
                            </table>
                          </div>
                        </div>
                      </div>
                    <% end %>
                  <% end %>
                </div>
              </div>
            </div><br>
            <% end %>
            <% if @keypair.tool_settings != 'none' && (current_user && !current_user.is_member?) %>
            <div class="hr-line-dashed"></div>
            <div class="ibox form-group collapsed">
                <label class="col-sm-2 control-label">Tool Settings
                  <a class="collapse-link">
                    <i class="fa fa-chevron-up text-muted"></i>
                  </a>
                </label>
                <div class="ibox-content">
                <% @keypair.tool_settings.each do |k, v| %>
                   <div class="form-group field col-lg-12" style="float: none">
                     <label><%= k.capitalize %></label>
                     <p class="form-control-static">
                       <% if v.is_a?(Hash) %>
                         <pre class="well well-sm pre-scrollable"><%= JSON.pretty_generate(v) %></pre>
                       <% else %>
                         <%= v %>
                       <% end %>
                     </p>
                   </div>
                <% end %>
                </div><br>
            </div>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
